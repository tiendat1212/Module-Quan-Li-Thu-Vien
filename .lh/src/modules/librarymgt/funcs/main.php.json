{
    "sourceFile": "src/modules/librarymgt/funcs/main.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1770119679085,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1770121172850,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,49 +8,52 @@\n  * @license GNU/GPL version 2 or any later version\n  * @see https://github.com/nukeviet The NukeViet CMS GitHub project\n  */\n \n-/**\n- * Danh sách sách\n- */\n if (!defined('NV_IS_MOD_LIBRABY')) {\n     exit('Stop!!!');\n }\n \n-$page = $nv_Request->get_page('page', 'get,post', 1);\n+$page_title = $module_info['site_title'];\n+\n+$array_data = [];\n $per_page = 10;\n+$page = $nv_Request->get_page('page', 'post,get', 1);\n+if ($page < 1) {\n+    $page = 1;\n+}\n $offset = ($page - 1) * $per_page;\n \n+$tb_books = NV_PREFIXLANG . '_' . $module_data . '_books';\n $tb_categories = NV_PREFIXLANG . '_' . $module_data . '_categories';\n-$tb_books = NV_PREFIXLANG . '_' . $module_data . '_books';\n \n-// categories list for filter UI\n-$categories = [];\n-$result = $db->query('SELECT id, name FROM ' . $tb_categories . ' ORDER BY name ASC');\n-while ($row = $result->fetch()) {\n-    $categories[(int) $row['id']] = $row['name'];\n-}\n+// Count items\n+$num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books . ' WHERE status = 1')->fetchColumn();\n \n-$page_title = $module_info['site_title'];\n-\n-$num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books)->fetchColumn();\n-\n-$sql = 'SELECT b.*, c.name AS category_name\n+// Fetch list (đúng schema: books.cat_id, categories.title)\n+$sql = 'SELECT b.id, b.title, b.author, b.quantity, b.add_time, c.title AS category_title\n         FROM ' . $tb_books . ' b\n-        LEFT JOIN ' . $tb_categories . ' c ON b.category_id = c.id\n-        ORDER BY b.id DESC\n+        LEFT JOIN ' . $tb_categories . ' c ON c.id = b.cat_id\n+        WHERE b.status = 1\n+        ORDER BY b.add_time DESC\n         LIMIT ' . $offset . ', ' . $per_page;\n \n-$array_data = [];\n $result = $db->query($sql);\n while ($row = $result->fetch()) {\n-        $array_data[] = $row;\n+    // add_time là INT timestamp\n+    $row['add_time'] = !empty($row['add_time']) ? nv_date('d/m/Y', (int) $row['add_time']) : '';\n+    $row['category_title'] = $row['category_title'] ?? '';\n+    $array_data[] = $row;\n }\n \n $page_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n-$generate_page = nv_generate_page($page_url, $num_items, $per_page, $page);\n+$generate_page = ($num_items > $per_page) ? nv_generate_page($page_url, $num_items, $per_page, $page) : '';\n \n-$contents = nv_theme_books_list($array_data, $categories, 0, $generate_page, $page_title);\n+// Include theme file that contains nv_theme_list function\n+include NV_ROOTDIR . '/themes/' . NV_CURRENTTHEME . '/modules/' . $module_name . '/theme.php';\n \n+// Gọi theme hiện có của module (theme.php -> nv_theme_list)\n+$contents = nv_theme_list($array_data, $generate_page);\n+\n include NV_ROOTDIR . '/includes/header.php';\n echo nv_site_theme($contents);\n include NV_ROOTDIR . '/includes/footer.php';\n"
                },
                {
                    "date": 1770121245846,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,58 @@\n+<?php\n+\n+/**\n+ * NukeViet Content Management System\n+ * @version 5.x\n+ * @author VINADES.,JSC <contact@vinades.vn>\n+ * @copyright (C) 2009-2025 VINADES.,JSC. All rights reserved\n+ * @license GNU/GPL version 2 or any later version\n+ * @see https://github.com/nukeviet The NukeViet CMS GitHub project\n+ */\n+\n+if (!defined('NV_IS_MOD_LIBRABY')) {\n+    exit('Stop!!!');\n+}\n+\n+require_once NV_ROOTDIR . '/modules/' . $module_file . '/theme.php';\n+\n+$page_title = $module_info['site_title'];\n+\n+$array_data = [];\n+$per_page = 10;\n+$page = $nv_Request->get_page('page', 'post,get', 1);\n+if ($page < 1) {\n+    $page = 1;\n+}\n+$offset = ($page - 1) * $per_page;\n+\n+$tb_books = NV_PREFIXLANG . '_' . $module_data . '_books';\n+$tb_categories = NV_PREFIXLANG . '_' . $module_data . '_categories';\n+\n+// Count items\n+$num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books . ' WHERE status = 1')->fetchColumn();\n+\n+// Fetch list (đúng schema: books.cat_id, categories.title)\n+$sql = 'SELECT b.id, b.title, b.author, b.quantity, b.add_time, c.title AS category_title\n+        FROM ' . $tb_books . ' b\n+        LEFT JOIN ' . $tb_categories . ' c ON c.id = b.cat_id\n+        WHERE b.status = 1\n+        ORDER BY b.add_time DESC\n+        LIMIT ' . $offset . ', ' . $per_page;\n+\n+$result = $db->query($sql);\n+while ($row = $result->fetch()) {\n+    // add_time là INT timestamp\n+    $row['add_time'] = !empty($row['add_time']) ? nv_date('d/m/Y', (int) $row['add_time']) : '';\n+    $row['category_title'] = $row['category_title'] ?? '';\n+    $array_data[] = $row;\n+}\n+\n+$page_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n+$generate_page = ($num_items > $per_page) ? nv_generate_page($page_url, $num_items, $per_page, $page) : '';\n+\n+// Gọi theme hiện có của module (theme.php -> nv_theme_list)\n+$contents = nv_theme_list($array_data, $generate_page);\n+\n+include NV_ROOTDIR . '/includes/header.php';\n+echo nv_site_theme($contents);\n+include NV_ROOTDIR . '/includes/footer.php';\n"
                },
                {
                    "date": 1770121260293,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,53 @@\n+<?php\n+\n+/**\n+ * NukeViet Content Management System\n+ * @version 5.x\n+ */\n+\n+if (!defined('NV_IS_MOD_LIBRABY')) {\n+    exit('Stop!!!');\n+}\n+\n+// Load theme functions of module (để có nv_theme_list)\n+require_once NV_ROOTDIR . '/modules/' . $module_file . '/theme.php';\n+\n+$page_title = $module_info['site_title'];\n+\n+$array_data = [];\n+$per_page = 10;\n+$page = $nv_Request->get_page('page', 'post,get', 1);\n+if ($page < 1) {\n+    $page = 1;\n+}\n+$offset = ($page - 1) * $per_page;\n+\n+$tb_books = NV_PREFIXLANG . '_' . $module_data . '_books';\n+$tb_categories = NV_PREFIXLANG . '_' . $module_data . '_categories';\n+\n+// Count items\n+$num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books . ' WHERE status = 1')->fetchColumn();\n+\n+// Fetch list\n+$sql = 'SELECT b.id, b.title, b.author, b.quantity, b.add_time, c.title AS category_title\n+        FROM ' . $tb_books . ' b\n+        LEFT JOIN ' . $tb_categories . ' c ON c.id = b.cat_id\n+        WHERE b.status = 1\n+        ORDER BY b.add_time DESC\n+        LIMIT ' . $offset . ', ' . $per_page;\n+\n+$result = $db->query($sql);\n+while ($row = $result->fetch()) {\n+    $row['add_time'] = !empty($row['add_time']) ? nv_date('d/m/Y', (int) $row['add_time']) : '';\n+    $row['category_title'] = $row['category_title'] ?? '';\n+    $array_data[] = $row;\n+}\n+\n+$page_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n+$generate_page = ($num_items > $per_page) ? nv_generate_page($page_url, $num_items, $per_page, $page) : '';\n+\n+$contents = nv_theme_list($array_data, $generate_page);\n+\n+include NV_ROOTDIR . '/includes/header.php';\n+echo nv_site_theme($contents);\n+include NV_ROOTDIR . '/includes/footer.php';\n"
                },
                {
                    "date": 1770121383207,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,46 +8,57 @@\n if (!defined('NV_IS_MOD_LIBRABY')) {\n     exit('Stop!!!');\n }\n \n-// Load theme functions of module (để có nv_theme_list)\n+// Load theme functions of module (để có nv_theme_books_list)\n require_once NV_ROOTDIR . '/modules/' . $module_file . '/theme.php';\n \n $page_title = $module_info['site_title'];\n \n-$array_data = [];\n $per_page = 10;\n $page = $nv_Request->get_page('page', 'post,get', 1);\n-if ($page < 1) {\n-    $page = 1;\n-}\n+$page = max(1, (int) $page);\n $offset = ($page - 1) * $per_page;\n \n $tb_books = NV_PREFIXLANG . '_' . $module_data . '_books';\n $tb_categories = NV_PREFIXLANG . '_' . $module_data . '_categories';\n \n-// Count items\n+$current_catid = 0; // Trang main = tất cả sách\n+\n+// 1) Lấy danh sách thể loại để hiển thị menu lọc\n+$categories = [];\n+$sql_cat = 'SELECT id, title FROM ' . $tb_categories . ' WHERE status = 1 ORDER BY weight ASC';\n+$result_cat = $db->query($sql_cat);\n+while ($cat = $result_cat->fetch()) {\n+    $categories[(int) $cat['id']] = $cat['title'];\n+}\n+\n+// 2) Đếm tổng sách (phân trang)\n $num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books . ' WHERE status = 1')->fetchColumn();\n \n-// Fetch list\n-$sql = 'SELECT b.id, b.title, b.author, b.quantity, b.add_time, c.title AS category_title\n+// 3) Lấy danh sách sách (join thể loại)\n+$books = [];\n+$sql = 'SELECT b.id, b.title, b.author, b.quantity, b.add_time, c.title AS name\n         FROM ' . $tb_books . ' b\n         LEFT JOIN ' . $tb_categories . ' c ON c.id = b.cat_id\n         WHERE b.status = 1\n         ORDER BY b.add_time DESC\n         LIMIT ' . $offset . ', ' . $per_page;\n \n $result = $db->query($sql);\n while ($row = $result->fetch()) {\n+    // Template của bạn đang dùng key `name` cho tên thể loại\n+    $row['name'] = $row['name'] ?? '';\n     $row['add_time'] = !empty($row['add_time']) ? nv_date('d/m/Y', (int) $row['add_time']) : '';\n-    $row['category_title'] = $row['category_title'] ?? '';\n-    $array_data[] = $row;\n+    $books[] = $row;\n }\n \n+// 4) Phân trang\n $page_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n $generate_page = ($num_items > $per_page) ? nv_generate_page($page_url, $num_items, $per_page, $page) : '';\n \n-$contents = nv_theme_list($array_data, $generate_page);\n+// 5) Render theo đúng theme.php\n+$contents = nv_theme_books_list($books, $categories, $current_catid, $generate_page, $page_title);\n \n include NV_ROOTDIR . '/includes/header.php';\n echo nv_site_theme($contents);\n include NV_ROOTDIR . '/includes/footer.php';\n"
                },
                {
                    "date": 1770122711349,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -8,9 +8,8 @@\n if (!defined('NV_IS_MOD_LIBRABY')) {\n     exit('Stop!!!');\n }\n \n-// Load theme functions of module (để có nv_theme_books_list)\n require_once NV_ROOTDIR . '/modules/' . $module_file . '/theme.php';\n \n $page_title = $module_info['site_title'];\n \n@@ -23,159 +22,14 @@\n $tb_categories = NV_PREFIXLANG . '_' . $module_data . '_categories';\n \n $current_catid = 0; // Trang main = tất cả sách\n \n-// 1) Lấy danh sách thể loại để hiển thị menu lọc\n-$categories = [];\n-$sql_cat = 'SELECT id, title FROM ' . $tb_categories . ' WHERE status = 1 ORDER BY weight ASC';\n-$result_cat = $db->query($sql_cat);\n-while ($cat = $result_cat->fetch()) {\n-    $categories[(int) $cat['id']] = $cat['title'];\n-}\n \n-// 2) Đếm tổng sách (phân trang)\n-$num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books . ' WHERE status = 1')->fetchColumn();\n-\n-// 3) Lấy danh sách sách (join thể loại)\n-$books = [];\n-$sql = 'SELECT b.id, b.title, b.author, b.quantity, b.add_time, c.title AS name\n-        FROM ' . $tb_books . ' b\n-        LEFT JOIN ' . $tb_categories . ' c ON c.id = b.cat_id\n-        WHERE b.status = 1\n-        ORDER BY b.add_time DESC\n-        LIMIT ' . $offset . ', ' . $per_page;\n-\n-$result = $db->query($sql);\n-while ($row = $result->fetch()) {\n-    // Template của bạn đang dùng key `name` cho tên thể loại\n-    $row['name'] = $row['name'] ?? '';\n-    $row['add_time'] = !empty($row['add_time']) ? nv_date('d/m/Y', (int) $row['add_time']) : '';\n-    $books[] = $row;\n-}\n-\n-// 4) Phân trang\n+//Phân trang\n $page_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n $generate_page = ($num_items > $per_page) ? nv_generate_page($page_url, $num_items, $per_page, $page) : '';\n \n-// 5) Render theo đúng theme.php\n $contents = nv_theme_books_list($books, $categories, $current_catid, $generate_page, $page_title);\n \n include NV_ROOTDIR . '/includes/header.php';\n echo nv_site_theme($contents);\n include NV_ROOTDIR . '/includes/footer.php';\n-<?php\n-\n-/**\n- * NukeViet Content Management System\n- * @version 5.x\n- * @author VINADES.,JSC <contact@vinades.vn>\n- * @copyright (C) 2009-2025 VINADES.,JSC. All rights reserved\n- * @license GNU/GPL version 2 or any later version\n- * @see https://github.com/nukeviet The NukeViet CMS GitHub project\n- */\n-\n-if (!defined('NV_IS_MOD_LIBRABY')) {\n-    exit('Stop!!!');\n-}\n-\n-require_once NV_ROOTDIR . '/modules/' . $module_file . '/theme.php';\n-\n-$page_title = $module_info['site_title'];\n-\n-$array_data = [];\n-$per_page = 10;\n-$page = $nv_Request->get_page('page', 'post,get', 1);\n-if ($page < 1) {\n-    $page = 1;\n-}\n-$offset = ($page - 1) * $per_page;\n-\n-$tb_books = NV_PREFIXLANG . '_' . $module_data . '_books';\n-$tb_categories = NV_PREFIXLANG . '_' . $module_data . '_categories';\n-\n-// Count items\n-$num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books . ' WHERE status = 1')->fetchColumn();\n-\n-// Fetch list (đúng schema: books.cat_id, categories.title)\n-$sql = 'SELECT b.id, b.title, b.author, b.quantity, b.add_time, c.title AS category_title\n-        FROM ' . $tb_books . ' b\n-        LEFT JOIN ' . $tb_categories . ' c ON c.id = b.cat_id\n-        WHERE b.status = 1\n-        ORDER BY b.add_time DESC\n-        LIMIT ' . $offset . ', ' . $per_page;\n-\n-$result = $db->query($sql);\n-while ($row = $result->fetch()) {\n-    // add_time là INT timestamp\n-    $row['add_time'] = !empty($row['add_time']) ? nv_date('d/m/Y', (int) $row['add_time']) : '';\n-    $row['category_title'] = $row['category_title'] ?? '';\n-    $array_data[] = $row;\n-}\n-\n-$page_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n-$generate_page = ($num_items > $per_page) ? nv_generate_page($page_url, $num_items, $per_page, $page) : '';\n-\n-// Gọi theme hiện có của module (theme.php -> nv_theme_list)\n-$contents = nv_theme_list($array_data, $generate_page);\n-\n-include NV_ROOTDIR . '/includes/header.php';\n-echo nv_site_theme($contents);\n-include NV_ROOTDIR . '/includes/footer.php';\n-<?php\n-\n-/**\n- * NukeViet Content Management System\n- * @version 5.x\n- * @author VINADES.,JSC <contact@vinades.vn>\n- * @copyright (C) 2009-2025 VINADES.,JSC. All rights reserved\n- * @license GNU/GPL version 2 or any later version\n- * @see https://github.com/nukeviet The NukeViet CMS GitHub project\n- */\n-\n-if (!defined('NV_IS_MOD_LIBRABY')) {\n-    exit('Stop!!!');\n-}\n-\n-$page_title = $module_info['site_title'];\n-\n-$array_data = [];\n-$per_page = 10;\n-$page = $nv_Request->get_page('page', 'post,get', 1);\n-if ($page < 1) {\n-    $page = 1;\n-}\n-$offset = ($page - 1) * $per_page;\n-\n-$tb_books = NV_PREFIXLANG . '_' . $module_data . '_books';\n-$tb_categories = NV_PREFIXLANG . '_' . $module_data . '_categories';\n-\n-// Count items\n-$num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books . ' WHERE status = 1')->fetchColumn();\n-\n-// Fetch list (đúng schema: books.cat_id, categories.title)\n-$sql = 'SELECT b.id, b.title, b.author, b.quantity, b.add_time, c.title AS category_title\n-        FROM ' . $tb_books . ' b\n-        LEFT JOIN ' . $tb_categories . ' c ON c.id = b.cat_id\n-        WHERE b.status = 1\n-        ORDER BY b.add_time DESC\n-        LIMIT ' . $offset . ', ' . $per_page;\n-\n-$result = $db->query($sql);\n-while ($row = $result->fetch()) {\n-    // add_time là INT timestamp\n-    $row['add_time'] = !empty($row['add_time']) ? nv_date('d/m/Y', (int) $row['add_time']) : '';\n-    $row['category_title'] = $row['category_title'] ?? '';\n-    $array_data[] = $row;\n-}\n-\n-$page_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n-$generate_page = ($num_items > $per_page) ? nv_generate_page($page_url, $num_items, $per_page, $page) : '';\n-\n-// Include theme file that contains nv_theme_list function\n-include NV_ROOTDIR . '/themes/' . NV_CURRENTTHEME . '/modules/' . $module_name . '/theme.php';\n-\n-// Gọi theme hiện có của module (theme.php -> nv_theme_list)\n-$contents = nv_theme_list($array_data, $generate_page);\n-\n-include NV_ROOTDIR . '/includes/header.php';\n-echo nv_site_theme($contents);\n-include NV_ROOTDIR . '/includes/footer.php';\n"
                },
                {
                    "date": 1770173933166,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,9 +4,9 @@\n  * NukeViet Content Management System\n  * @version 5.x\n  */\n \n-if (!defined('NV_IS_MOD_LIBRABY')) {\n+if (!defined('NV_IS_MOD_LIBRABYMGT')) {\n     exit('Stop!!!');\n }\n \n require_once NV_ROOTDIR . '/modules/' . $module_file . '/theme.php';\n"
                }
            ],
            "date": 1770119679085,
            "name": "Commit-0",
            "content": "<?php\n\n/**\n * NukeViet Content Management System\n * @version 5.x\n * @author VINADES.,JSC <contact@vinades.vn>\n * @copyright (C) 2009-2025 VINADES.,JSC. All rights reserved\n * @license GNU/GPL version 2 or any later version\n * @see https://github.com/nukeviet The NukeViet CMS GitHub project\n */\n\n/**\n * Danh sách sách\n */\nif (!defined('NV_IS_MOD_LIBRABY')) {\n    exit('Stop!!!');\n}\n\n$page = $nv_Request->get_page('page', 'get,post', 1);\n$per_page = 10;\n$offset = ($page - 1) * $per_page;\n\n$tb_categories = NV_PREFIXLANG . '_' . $module_data . '_categories';\n$tb_books = NV_PREFIXLANG . '_' . $module_data . '_books';\n\n// categories list for filter UI\n$categories = [];\n$result = $db->query('SELECT id, name FROM ' . $tb_categories . ' ORDER BY name ASC');\nwhile ($row = $result->fetch()) {\n    $categories[(int) $row['id']] = $row['name'];\n}\n\n$page_title = $module_info['site_title'];\n\n$num_items = (int) $db->query('SELECT COUNT(*) FROM ' . $tb_books)->fetchColumn();\n\n$sql = 'SELECT b.*, c.name AS category_name\n        FROM ' . $tb_books . ' b\n        LEFT JOIN ' . $tb_categories . ' c ON b.category_id = c.id\n        ORDER BY b.id DESC\n        LIMIT ' . $offset . ', ' . $per_page;\n\n$array_data = [];\n$result = $db->query($sql);\nwhile ($row = $result->fetch()) {\n        $array_data[] = $row;\n}\n\n$page_url = NV_BASE_SITEURL . 'index.php?' . NV_LANG_VARIABLE . '=' . NV_LANG_DATA . '&amp;' . NV_NAME_VARIABLE . '=' . $module_name;\n$generate_page = nv_generate_page($page_url, $num_items, $per_page, $page);\n\n$contents = nv_theme_books_list($array_data, $categories, 0, $generate_page, $page_title);\n\ninclude NV_ROOTDIR . '/includes/header.php';\necho nv_site_theme($contents);\ninclude NV_ROOTDIR . '/includes/footer.php';\n"
        }
    ]
}